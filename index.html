<!DOCTYPE html>
<html>
   <head>
      <title>Octopussy: Which GitHubbers are following you?</title>
      <script src="https://ajax.googleapis.com/ajax/libs/mootools/1.3.2/mootools-yui-compressed.js" type="text/javascript"></script>
      <script src="github.js" type="text/javascript"></script>
      <style>
         #data {
            display: none;
            margin: 20px;
         }
      </style>
   </head>
   <body>
      <h1>Octopussy</h1>
      <p>So I was dicking around with <a href="http://coderwall.com/icco" title="icco on CodeWall">CodeWall</a>, and I got the Octopussy badge. This was really awesome, but I had no idea who from GitHub was following my projects. So I decided to write me some JavaScript to figure it out.</p>

      <form id="form" method="post">
         <input type="text" id="username" name="username"></input>
         <input type="submit"></input>
      </form>

      <div id="data">
         It looks like you have <span id="repocount">0</span> repos.

         <ul id="repos">
         </ul>
      </div>

      <script type="text/javascript">
         Array.implement({ 
             intersection: function(array) {
                 var clone = Array.clone(this);
                 for (var i = 0, l = clone.length; i < l; i++){
                     if (!array.contains(clone[i])) clone.erase(clone[i])
                 }
                 return clone;
             }
         });

         var githubbers = [];
         new Request.JSON({
            "url": "https://github.com/api/v2/json/organizations/github/public_members",
            "method": "get",
            "onSuccess": function(d) {
               d["users"].each(function(u) {
                  githubbers.push(u.login);
               });
            },
         }).send();

         console.log(githubbers);

         $('form').addEvent('submit', function(ev) {
            ev.preventDefault();
            $('repocount').set('text', "0")
            $('repos').set('html', "")
            $('data').setStyle('display', 'block');

            var user = gh.user($("username").get("value"));

            user.repos(function (data) {
                $('repocount').set('text', data.repositories.length);
                var gh = [];

                data.repositories.each(function(repo) {
                   if (repo.watchers > 1) {
                      var options = {
                         "url": "https://github.com/api/v2/json/repos/show/" + user.username + "/" + repo.name + "/watchers",
                         "method": "get",
                         "onSuccess": function(d) {
                            gh = d["watchers"].intersect(githubbers);
                         },
                      };

                      new Request.JSON(options).send();

                      if (gh.size() > 0) {
                         var li = new Element('li');
                         li.set('text', repo.name + ": " + gh.toString());
                         $('repos').adopt(li);
                      }
                   }
                });
            });
         });
      </script>
   </body>
</html>
